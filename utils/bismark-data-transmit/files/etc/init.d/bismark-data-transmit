#!/bin/sh /etc/rc.common

START=97
PIDFILE=/var/run/bismark-data-transmit.pid

load_directories() {
    local cfg="$1"
    local directories
    config_get directories "$cfg" directory
    for directory in $directories; do
        mkdir -p /tmp/bismark-uploads/$directory
    done
}

load_urls() {
    local cfg="$1"
    config_get DATA_TRANSMIT_ARGUMENTS "$cfg" url
}

start() {
    config_load bismark-data-transmit
    config_foreach load_directories directories
    config_foreach load_urls urls
    mkdir -p /tmp/bismark-uploads
    if [ -f $PIDFILE ]; then
        echo "pidfile $PIDFILE already exists; bismark-data-transmit already running?"
        exit 1
    fi
    start-stop-daemon -S \
        -x /usr/bin/bismark-data-transmit \
        -p $PIDFILE \
        -m -b -- $DATA_TRANSMIT_ARGUMENTS
}

stop() {
    [ -f $PIDFILE ] && {
        start-stop-daemon -K -q -p $PIDFILE -s TERM
        rm -f $PIDFILE
    }
}

restart() {
    stop
    start
}
